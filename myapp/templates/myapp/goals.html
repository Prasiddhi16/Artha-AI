{% extends 'myapp/base.html' %}
{% load static %}
{% block title %} Goals page {% endblock %}
{% block content %}
       
        <div class="main-content">
        <div class="overview">
            <div class="textblock">
        <section  class="idea">Financial Goals</section>
        <section class="work">Track and achieve your savings targets</section>
             </div>
            <button class="addgoalbtn"><i class="fas fa-plus-circle"></i>   Add Goal</button>
             <div id="addgoal-dialog" class="dialoggoal">
            <div class="dialog-content">
    <span id="close-dialog" class="close">&times;</span>
    <br>
    <div class="dialogtopic"> Add Financial Goal</div>
    <div class="dialogexplain">Create a new savings goal to track your progress</div>

   <form method="POST" class="goal-form">
    {% csrf_token %}
    <div class="form-group">
        <label for="goal-title">Goal Title</label>
        <input type="text" id="goal-title" name="title" placeholder="e.g., Emergency Fund" required>
    </div>

    <div class="form-group">
        <label for="target-amount">Target Amount</label>
        <input type="number" id="target-amount" name="target_amount" placeholder="$0.00" min="0" step="0.01" required>
    </div>

    <div class="form-group">
        <label for="category">Category</label>
        <select id="category" name="category" required>
            <option value="" disabled selected>Select category</option>
            <option value="savings">Savings</option>
            <option value="investment">Investment</option>
            <option value="emergency">Emergency</option>
        </select>
    </div>

    <div class="form-group">
        <label for="target-date">Target Date</label>
        <input type="date" id="target-date" name="target_date" required>
    </div>

    <div class="form-actions">
        <button type="submit" class="submit-btn">Add Goal</button>
        <button type="button" class="cancel-btn" onclick="handleCancel()">Cancel</button>
    </div>
</form>

  

    </div>
    </div>
        </div>
        <div class="goalview">
            <div class="viewcard">
                <div class="content">
                <section class="main">
                    <span>Total Goals</span>
                    <i  class="fas fa-bullseye"></i>
                </section>
                <section class="goalnumber">3</section>
                <section class="completegoal">0 goals completed</section>
                </div>
            </div>

            <div class="viewcard">
                <div class="content">
                <section class="main">
                    <span>Total Target</span>
                   <i class="fas fa-arrow-trend-up"></i> 
                </section>
                <section class="goalnumber"style="color:rgb(109,109,224);">$17000.00</section>
                <section class="completegoal">$650.00 saved</section>
            </div>
            </div>

            <div class="viewcard">
    <div class="content">
                <section class="main">
                    <span>Overall Progress</span>
                    <i class="fas fa-calendar"></i>
                </section>
                <section class="goalnumber">38%</section>
               <div class="progressbar">
               <div class="progressfill" style="width: 38%;"></div>
                </div>

            </div>
            </div>

        </div>
      <div class="slot-container">
  <div class="tab-buttons">
    <button class="tab-btn active" onclick="showPanel(this, 'goals')">
      <span class="tab-icon"><i class="fas fa-bullseye"></i></span> My Goals
    </button>
    <button class="tab-btn" onclick="showPanel(this, 'milestones')">
      <span class="tab-icon"><i class="fas fa-flag"></i></span> Milestones
    </button>
  </div>

  <div id="milestones"  class="tab-panel">
     <span class="active">Milestones</span>
    <div class="milestonegrid">
      <div class="milestonecard">
        <div class="goalheader">
    <span class="goalname"><i class="fas fa-trophy"></i>
</i> Milestones</span>
   <button class="complete"> 45% Complete</button></button>
  </div>
  <div class="type">Track your progress checkpoints</div>
   <div class="milestone-tracker">
  <div class="milestone-item completed">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-seedling" ></i> First Quarter
    </div>
    <div class="milestone-status">
      <i class="fas fa-check-circle" style="color: green;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$2,500.00</div>
    
  </div>

  <div class="milestone-item active">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag" ></i> Halfway There
    </div>
    <div class="milestone-status">
      <i class="fas fa-hourglass" style="color: gold;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$5,000.00</div>
    
  </div>

  <div class="milestone-item upcoming">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag-checkered" ></i> Final Stretch
    </div>
    <div class="milestone-status">
      <i class="fas fa-running" style="color: navy;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$7,500.00</div>
    
  </div>

  <div class="milestone-item upcoming">
     <div class="container">
    <div class="milestone-label">
      <i class="fas fa-trophy" ></i> Goal Achieved
    </div>
    <div class="milestone-status">
      <i class="fas fa-star" style="color: gold;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$10,000.00</div>
    
  </div>
  
</div>    
    </div>
    

    <div class="milestonecard">
        <div class="goalheader">
    <span class="goalname"><i class="fas fa-trophy"></i>
</i> Milestones</span>
   <button class="complete"> 45% Complete</button></button>
  </div>
  <div class="type">Track your progress checkpoints</div>
   <div class="milestone-tracker">
  <div class="milestone-item completed">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-seedling" ></i> First Quarter
    </div>
    <div class="milestone-status">
      <i class="fas fa-check-circle" style="color: green;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$2,500.00</div>
    
  </div>

  <div class="milestone-item active">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag" ></i> Halfway There
    </div>
    <div class="milestone-status">
      <i class="fas fa-hourglass" style="color: gold;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$5,000.00</div>
    
  </div>

  <div class="milestone-item upcoming">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag-checkered" ></i> Final Stretch
    </div>
    <div class="milestone-status">
      <i class="fas fa-running" style="color: navy;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$7,500.00</div>
    
  </div>

  <div class="milestone-item upcoming">
     <div class="container">
    <div class="milestone-label">
      <i class="fas fa-trophy" ></i> Goal Achieved
    </div>
    <div class="milestone-status">
      <i class="fas fa-star" style="color: gold;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$10,000.00</div>
    
  </div>
  
</div>    
    </div>

    <div class="milestonecard">
        <div class="goalheader">
    <span class="goalname"><i class="fas fa-trophy"></i>
</i> Milestones</span>
   <button class="complete"> 45% Complete</button></button>
  </div>
  <div class="type">Track your progress checkpoints</div>
   <div class="milestone-tracker">
  <div class="milestone-item completed">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-seedling" ></i> First Quarter
    </div>
    <div class="milestone-status">
      <i class="fas fa-check-circle" style="color: green;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$2,500.00</div>
    
  </div>

  <div class="milestone-item active">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag" ></i> Halfway There
    </div>
    <div class="milestone-status">
      <i class="fas fa-hourglass" style="color: gold;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$5,000.00</div>
    
  </div>

  <div class="milestone-item upcoming">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag-checkered" ></i> Final Stretch
    </div>
    <div class="milestone-status">
      <i class="fas fa-running" style="color: navy;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$7,500.00</div>
    
  </div>

  <div class="milestone-item upcoming">
     <div class="container">
    <div class="milestone-label">
      <i class="fas fa-trophy" ></i> Goal Achieved
    </div>
    <div class="milestone-status">
      <i class="fas fa-star" style="color: gold;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$10,000.00</div>
    
  </div>
  
</div>    
    </div>

    <div class="milestonecard">
        <div class="goalheader">
    <span class="goalname"><i class="fas fa-trophy"></i>
</i> Milestones</span>
   <button class="complete"> 45% Complete</button></button>
  </div>
  <div class="type">Track your progress checkpoints</div>
   <div class="milestone-tracker">
  <div class="milestone-item completed">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-seedling" ></i> First Quarter
    </div>
    <div class="milestone-status">
      <i class="fas fa-check-circle" style="color: green;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$2,500.00</div>
    
  </div>

  <div class="milestone-item active">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag" ></i> Halfway There
    </div>
    <div class="milestone-status">
      <i class="fas fa-hourglass" style="color: gold;"></i> Completed
    </div>
    </div>
    <div class="milestone-target">$5,000.00</div>
    
  </div>

  <div class="milestone-item upcoming">
    <div class="container">
    <div class="milestone-label">
      <i class="fas fa-flag-checkered" ></i> Final Stretch
    </div>
    <div class="milestone-status">
      <i class="fas fa-running" style="color: navy;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$7,500.00</div>
    
  </div>

  <div class="milestone-item upcoming">
     <div class="container">
    <div class="milestone-label">
      <i class="fas fa-trophy" ></i> Goal Achieved
    </div>
    <div class="milestone-status">
      <i class="fas fa-star" style="color: gold;"></i> Not yet reached
    </div>
    </div>
    <div class="milestone-target">$10,000.00</div>
    
  </div>
  
</div>    
    </div>

  </div>
  </div>

  <div id="goals" class="tab-panel active">
            <span class="active">Active Goals</span>
            <div class="goalgrid">
            {% for goal in user_goals %}
<div class="goalcard" data-goal-id="{{ goal.id }}">

  <div class="goalheader">
    <span class="goalname">
      <i class="fas fa-bullseye"></i> {{ goal.title }}
    </span>
   <i class="fas fa-trash-alt delete-goal" data-goal-id="{{ goal.id }}"></i>
  </div>

  <div class="type">{{ goal.category|title }}</div>

  <div class="progresscard">
    <div class="info">Progress</div>

    <div class="values">
      <span class="goalsaved">₹{{ goal.total_contributed }}</span>
      <span class="divider">/</span>
      <span class="goalvalue">₹{{ goal.target_amount }}</span>
    </div>

    <div class="progressbar">
  <div class="progressfill" style="width:{{ goal.progress_percent|floatformat:1 }}%;"></div>
</div>

<div class="percentage">
  {{ goal.progress_percent|floatformat:1 }}% complete
</div>
  </div>

  <div class="goalend">
    <div class="inf">
      Remaining
      <div class="goalremaining">
         ₹{{ goal.remaining_amount|floatformat:2 }}
      </div>
    </div>

    <div class="inf">
      Deadline
      <div class="goaldeadline">
        {% if goal.days_remaining is not None %}
    {{ goal.days_remaining }} days
  {% else %}
    N/A
  {% endif %}
      </div>
    </div>
  </div>
<button class="contributebtn" data-goal-id="{{ goal.id }}"
          data-goal-title="{{ goal.title }}"
          data-total="{{ goal.total_contributed }}"
          data-target="{{ goal.target_amount }}"
          data-progress="{{ goal.progress_percent|floatformat:0 }}">
    Add Contribution
  </button>

</div>
{% empty %}
<p>No goals added yet.</p>
{% endfor %}

<div id="addcontribution-dialog" class="dialoggoal">
  <div class="dialog-content">
    <span id="close-contribution-dialog" class="close">&times;</span>
    <br>
    <div class="dialogtopic">Add Contribution</div>
    <div class="dialogexplain">Record a new contribution towards your goal</div>

    <div class="topbox">
      <div class="line1">
        <div class="ctext">
          Current Progress
        </div>
        <div class="cprogresscard">
          <div class="values">
            <span class="goalsaved">₹0</span>
            <span class="divider">/</span>
            <span class="goalvalue">₹0</span>
          </div>
          <div class="progressbar">
            <div class="progressfill" style="width:0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <form method="POST" class="contribution-form" id="contribution-form">
      {% csrf_token %}
      <input type="hidden" name="goal_id" id="contribution-goal-id">

      <div class="form-group">
        <label for="contribution-amount">Contribution Amount</label>
        <input type="number" id="contribution-amount" name="amount" placeholder="$0.00" min="0" step="0.01" required>
      </div>

      <div class="form-group">
        <label for="contribution-date">Contribution Date</label>
        <input type="date" id="contribution-date" name="date" required>
      </div>

      <div class="form-group">
        <label for="contribution-note">Note (optional)</label>
        <input type="text" id="contribution-note" name="note" placeholder="e.g., Salary deposit">
      </div>

      <div class="form-actions">
        <button type="submit" class="submit-btn">Add Contribution</button>
        <button type="button" class="cancel-btn" onclick="handleContributionCancel()">Cancel</button>
      </div>
    </form>
  </div>
</div>

            
            </div>
            </div>
        
  {% endblock %}

{% block extra_css %} 
<link rel="stylesheet" href="{% static 'myapp/css/goalsstyle.css' %}">
{% endblock %}



{% block extra_js %}
<script>
    
      
    // Add Goal dialog elements
const addGoalBtn = document.querySelector('.addgoalbtn');
const addGoalDialog = document.getElementById('addgoal-dialog');
const closeGoalBtn = document.getElementById('close-dialog');

// Open dialog on button click
addGoalBtn.addEventListener('click', () => {
  addGoalDialog.style.display = 'block';
});

// Close dialog when clicking the close icon
closeGoalBtn.addEventListener('click', () => {
  addGoalDialog.style.display = 'none';
});

// Close when clicking outside the dialog
window.addEventListener('click', (e) => {
  if (e.target === addGoalDialog) {
    addGoalDialog.style.display = 'none';
  }
});

// Cancel button function
function handleCancel() {
  document.querySelector('.goal-form').reset();
  addGoalDialog.style.display = 'none';
}

  // Contribution dialog elements
const contributionDialog = document.getElementById('addcontribution-dialog');
const closeContributionBtn = document.getElementById('close-contribution-dialog');
const contributionForm = document.getElementById('contribution-form');
const contributionGoalIdInput = document.getElementById('contribution-goal-id');

// Add click event to all contribution buttons
document.querySelectorAll('.contributebtn').forEach(btn => {
  btn.addEventListener('click', () => {
    const goalId = btn.dataset.goalId;
    const goalTitle = btn.dataset.goalTitle;
    const total = btn.dataset.total;
    const target = btn.dataset.target;
    const progress = btn.dataset.progress;

    // Fill hidden input with goal ID
    contributionGoalIdInput.value = goalId;

    // Update top box info dynamically
    contributionDialog.querySelector('.goalsaved').textContent = `₹${total}`;
    contributionDialog.querySelector('.goalvalue').textContent = `₹${target}`;
    contributionDialog.querySelector('.progressfill').style.width = `${progress}%`;
    

    // Show dialog
    contributionDialog.style.display = 'block';
  });
});



// Close dialog
closeContributionBtn.addEventListener('click', () => {
  contributionDialog.style.display = 'none';
});

// Close when clicking outside
window.addEventListener('click', (e) => {
  if (e.target === contributionDialog) {
    contributionDialog.style.display = 'none';
  }
});

// Cancel button function
function handleContributionCancel() {
  contributionForm.reset();
  contributionDialog.style.display = 'none';
}
contributionForm.addEventListener('submit', function(e) {
  e.preventDefault();
  contributionDialog.style.display = 'none';

  const formData = new FormData(contributionForm);

  fetch("{% url 'add_contribution_ajax' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': formData.get('csrfmiddlewaretoken')
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    // Find the goal card in the DOM
    const goalCard = document.querySelector(`.goalcard[data-goal-id='${data.id}']`);
    if (!goalCard) return;

    // Update progress values
    goalCard.querySelector('.goalsaved').textContent = `₹${parseFloat(data.total_contributed).toFixed(2)}`;
    goalCard.querySelector('.goalremaining').textContent = `₹${parseFloat(data.remaining_amount).toFixed(2)}`;
    goalCard.querySelector('.progressfill').style.width = `${data.progress_percent}%`;
    goalCard.querySelector('.percentage').textContent = `${data.progress_percent}% complete`;

    // Update dialog too
    contributionDialog.querySelector('.goalsaved').textContent = `₹${parseFloat(data.total_contributed).toFixed(2)}`;
    contributionDialog.querySelector('.goalremaining').textContent = `₹${parseFloat(data.remaining_amount).toFixed(2)}`;
    contributionDialog.querySelector('.progressfill').style.width = `${data.progress_percent}%`;

    contributionForm.reset();
    contributionDialog.style.display = 'none';
  })
  .catch(err => console.error(err));
});
// Contribution dialog elements

function showPanel(button, panelId) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

  button.classList.add('active');
  document.getElementById(panelId).classList.add('active');
}
// Delete goal functionality
document.querySelectorAll('.goalcard .fa-trash-alt').forEach(icon => {
  icon.addEventListener('click', () => {
    if (!confirm("Are you sure you want to delete this goal?")) return;

    const goalCard = icon.closest('.goalcard');
    const goalId = goalCard.dataset.goalId;

    const formData = new FormData();
    formData.append('goal_id', goalId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'delete_goal' %}", {
      method: 'POST',
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else if (data.success) {
        goalCard.remove(); // Remove from DOM
        alert("Goal deleted successfully!");
      }
    })
    .catch(err => console.error(err));
  });
});

     </script>
  {% endblock %}
